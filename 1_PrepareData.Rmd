---
title: "1_RR_PrepareData"
author: "Nina-Alisa Kollakowski"
date: "`r Sys.Date()`"
output: html_document
---

```{r initialize}
library(dplyr)
```

## Demographic Data
```{r}
#read csv data
demographicData_buffer <- read.csv("./Data/demographicData.csv")

#prepare data frame
demographicData <- demographicData_buffer %>%
  mutate(education_mother = Secondary_Education_Mother_num + Tertiary_Education_Mother_num,
         education_father = Secondary_Education_Father_num + Tertiary_Education_Father_num) %>% #add secondary and tertiary education scores of mother and father
  select(ID,
         education_mother,
         education_father,
         Age_Mother,
         Age_Father,
         Marital_Status_num,
         Siblings_num,
         Primary_Language_Child_num,
         Primary_Caretaker_num,
         age_T1_spatialContingency,
         age_T1_temporalContingency,
         age_T2_reaching,
         age_T2_sensoryAttenuation,
         age_T3)

#define categorical variables as factors
demographicData$Siblings_num <- as.factor(demographicData$Siblings_num)
demographicData$Primary_Language_Child_num <- as.factor(demographicData$Primary_Language_Child_num)
demographicData$Primary_Caretaker_num <- as.factor(demographicData$Primary_Caretaker_num)
demographicData$sex <- as.factor(demographicData$sex)
demographicData$Marital_Status_num <- as.factor(demographicData$Marital_Status_num)

#remove temporary variables
rm(demographicData_buffer)
```


## Spatial Contingency Data

```{r}
#read csv data
spatialContingencyData_buffer <- read.csv("./Data/spatialContingencyData.csv")

#create contingency preference scores necessary for analysis
spatialContingencyData <- spatialContingencyData_buffer %>%
  group_by(id, view) %>%
  summarise(looking_s = sum(lookingDuration),
            legMovement_s = sum(legMovementDuration)) %>% #sum data by condition
  filter(view != "away") %>% #exclude times when child looks away from screen
  tidyr::pivot_wider(names_from = view, values_from = c("looking_s", "legMovement_s")) %>%
  mutate(lookingScore = looking_s_mirrored/(looking_s_mirrored + looking_s_ego),
         legMovementScore = legMovement_s_mirrored/(legMovement_s_mirrored + legMovement_s_ego)) %>% #create contingency preference scores
  mutate(legMovementScore_corrected = ifelse(is.na(legMovementScore), 0.5, legMovementScore)) %>% #correct instances, in which no leg contingency score could be created because of no leg movement -> make this 0.5
  select(id, lookingScore, legMovementScore_corrected) %>%
  rename(spatialContingency_looking = lookingScore,
         spatialContingency_legs = legMovementScore_corrected)

#remove buffer data frame
rm(spatialContingencyData_buffer)
```

## Temporal Contingency Data - Looking

```{r}
#read csv data
temporalContingencyData_looking_buffer <- read.csv("./Data/temporalContingencyLookingData.csv")

#create contingency preference scores necessary for analysis
temporalContingencyData_looking <- temporalContingencyData_looking_buffer %>%
  select(ID, condition, mean_looking) %>%
  tidyr::pivot_wider(names_from = condition, values_from = mean_looking) %>% 
  mutate(lookingScore = delayed/(delayed + online)) %>% #create contingency preference score
  select(ID, lookingScore) %>%
  rename(id = ID,
         temporalContingency_looking = lookingScore)

#remove buffer data frame
rm(temporalContingencyData_looking_buffer)
```

## Temporal Contingency Data - fNIRS
```{r create time bins}
#read csv data
fnirsData_ROI_long <- read.csv("./Data/temporalContingencyfNIRSData.csv")

#create time bins and summarise data within these
n_bins <- 10
fnirsData_binned <- fnirsData_ROI_long %>%
  mutate(bins = ntile(time, n = n_bins)) %>%
  group_by(subject, condition, hemisphere, bins) %>%
  summarise(HbO = mean(HbO),
            HbR = mean(HbR))

#label time bins, condition, and subject as factors for ANOVA to work correctly
fnirsData_binned$bins <- as.factor(fnirsData_binned$bins)
fnirsData_binned$condition <- as.factor(fnirsData_binned$condition)
fnirsData_binned$subject <- as.factor(fnirsData_binned$subject)
```

```{r analyze left HbO}
#ANOVA on HbO-data in left ROI (main effect of time, condition + interaction effect)
timeAnova_left_HbO <- ez::ezANOVA(fnirsData_binned[fnirsData_binned$hemisphere == "l",],
                                  dv = HbO,
                                  wid = subject,
                                  within = c(bins, condition))
print(timeAnova_left_HbO)

#Post-Hoc T-Tests of time bins
##initialize empty data frame for results
bins_left_HbO <- data.frame(matrix(nrow = n_bins, ncol = 3))
colnames(bins_left_HbO) <- c("bins", "t", "p")
bins_left_HbO$bins <- 1:n_bins

##compute t-tests between conditions for each time bin and save data
for (i in levels(fnirsData_binned$bins)){
  currentData <- fnirsData_binned %>%
    filter(bins == i,
           hemisphere == "l") %>%
    ungroup() %>%
    select(subject, condition, HbO) %>%
    tidyr::pivot_wider(names_from = "condition", values_from = "HbO")
  currentTest <- t.test(currentData$delayed, currentData$online, paired = TRUE)
  bins_left_HbO[i, "p"] <- currentTest$p.value
  bins_left_HbO[i, "t"] <- currentTest$statistic
}

#compute difference score between conditions in significant time bins
left_HbO_diff <- fnirsData_binned %>%
  filter(hemisphere == "l",
         bins %in%  which(bins_left_HbO$p < 0.05)) %>%
  group_by(subject, condition) %>%
  summarise(m_HbO = mean(HbO)) %>%
  select(subject, condition, m_HbO) %>%
  tidyr::pivot_wider(names_from = condition, values_from = m_HbO) %>%
  mutate(leftHbOScore = delayed - online) %>%
  select(subject, leftHbOScore)

```

```{r analyze right HbO}
#ANOVA on HbO-data in right ROI (main effect of time, condition + interaction effect)
timeAnova_right_HbO <- ez::ezANOVA(fnirsData_binned[fnirsData_binned$hemisphere == "r",],
                                   dv = HbO,
                                   wid = subject,
                                   within = c(bins, condition))
print(timeAnova_right_HbO)

#Post-Hoc T-Tests of time bins
##initialize empty data frame for results
bins_right_HbO <- data.frame(matrix(nrow = n_bins, ncol = 3))
colnames(bins_right_HbO) <- c("bins","t", "p")
bins_right_HbO$bins <- 1:n_bins

##compute t-tests between conditions for each time bin and save data
for (i in levels(fnirsData_binned$bins)){
  currentData <- fnirsData_binned %>%
    filter(bins == i,
           hemisphere == "r") %>%
    ungroup() %>%
    select(subject, condition, HbO) %>%
    tidyr::pivot_wider(names_from = "condition", values_from = "HbO")
  currentTest <- t.test(currentData$delayed, currentData$online, paired = TRUE)
  bins_right_HbO[i, "p"] <- currentTest$p.value
  bins_right_HbO[i, "t"] <- currentTest$statistic
}

#compute difference score between conditions in significant time bins
right_HbO_diff <- fnirsData_binned %>%
  filter(hemisphere == "r",
         bins %in%  which(bins_right_HbO$p < 0.05)) %>%
  group_by(subject, condition) %>%
  summarise(m_HbO = mean(HbO)) %>%
  select(subject, condition, m_HbO) %>%
  tidyr::pivot_wider(names_from = condition, values_from = m_HbO) %>%
  mutate(rightHbOScore = delayed - online) %>%
  select(subject, rightHbOScore)

```

```{r analyze left HbR}
#ANOVA on HbR-data in left ROI (main effect of time, condition + interaction effect)
timeAnova_left_HbR <- ez::ezANOVA(fnirsData_binned[fnirsData_binned$hemisphere == "l",],
                                  dv = HbR,
                                  wid = subject,
                                  within = c(bins, condition))
print(timeAnova_left_HbR)

#no significant effects of condition - so no post-hoc tests necessary
```

```{r analyze right HbR}
#ANOVA on HbR-data in right ROI (main effect of time, condition + interaction effect)
timeAnova_right_HbR <- ez::ezANOVA(fnirsData_binned[fnirsData_binned$hemisphere == "r",],
                                   dv = HbR,
                                   wid = subject,
                                   within = c(bins, condition))
print(timeAnova_right_HbR)
#no significant effects of condition - so no post-hoc tests necessary
```

```{r clean-up}
#merge all temporal contingency data frames
temporalContingencyData <- merge(temporalContingencyData_looking, 
                                 merge(left_HbO_diff, right_HbO_diff, by = "subject", all = TRUE),
                                 by.x = "id", by.y = "subject", all = TRUE) %>%
  rename(temporalContingency_left = leftHbOScore,
         temporalContingency_right = rightHbOScore)

#remove temporary variables
rm(list = c("n_bins", 
            "timeAnova_left_HbO", 
            "timeAnova_left_HbR", 
            "timeAnova_right_HbO",
            "timeAnova_right_HbR",
            "bins_left_HbO", 
            "bins_right_HbO",
            "temporalContingencyData_looking",
            "left_HbO_diff",
            "right_HbO_diff",
            "currentTest",
            "fnirsData_binned",
            "fnirsData_ROI_long",
            "i",
            "currentData"))
```

## Reaching to the Self Data
```{r}
#read csv data
reachingToSelfData_buffer <- read.csv("./Data/reachingData.csv")

#calculating proportion of trials with successful contact
reachingToSelfData <- reachingToSelfData_buffer %>%
  filter(Contact_Success != -99) %>% #exclude trials with no data (because excluded)
  group_by(ID, Target_Location_general) %>%
  summarise(n_trials = n(),
            proportionContact = sum(Contact_Success)/n_trials) %>% #calculate proportion of trials with successful contact for arm/head separately
  mutate(proportionContact = ifelse(n_trials < 2, NA, proportionContact)) %>% #exclude data if less than 2 trials contributed
  select(-n_trials) %>%
  tidyr::pivot_wider(names_from = Target_Location_general, values_from = proportionContact) %>%
  rename(id = ID,
         reaching_arm = arm,
         reaching_head = head)

#remove temporary variable
rm(reachingToSelfData_buffer)
```

## Sensory Attenuation (EEG) Data
```{r}
#read csv data
sensoryAttenuationData_buffer <- read.csv("./Data/sensoryAttenuation.csv")

#rename data for easier use
sensoryAttenuationData <- sensoryAttenuationData_buffer %>%
  rename(id = ID,
         sensoryAttenuation_pos = posCluster,
         sensoryAttenuation_neg = negCluster)

#remove temporary variable
rm(sensoryAttenuationData_buffer)
```

## Mirror Self-Recognition Data
```{r}
#read csv data
mirrorSelfRecognitionData_buffer <- read.csv("./Data/mirrorSelfRecognitionData.csv")

#clean data frame
mirrorSelfRecognitionData <- mirrorSelfRecognitionData_buffer %>%
  filter(Recognition != -99) %>% #exclude trials without data
  select(ID, Recognition) %>%
  rename(id = ID,
         mirrorSelfRecognition = Recognition)

#remove temporary variable
rm(mirrorSelfRecognitionData_buffer)
```

## Video Self-Recognition Data
```{r}
#load data from blind coding
videoSelfRecognitionData_blind <- read.csv("./Data/videoSelfRecognitionData_blind.csv")

#load condition data
conditions <- read.csv("./Data/videoSelfRecognitionData_conditions.csv")

#merge together and only consider children that responded correctly in both conditions as recognizer
videoSelfRecognitionData <- merge(videoSelfRecognitionData_blind, conditions, by.x = c("ID", "Condition"), by.y = c("ID", "Video")) %>%
  select(ID, self.recognition, Condition.y) %>%
  tidyr::pivot_wider(names_from = Condition.y, values_from = self.recognition) %>%
  mutate(selfRecognition = ifelse(self == "y" & other == "n", 1, 0)) %>%
  select(ID, selfRecognition) %>%
  rename(id = ID,
         videoSelfRecognition = selfRecognition)

#remove temporary variables
rm(list = c("conditions",
            "videoSelfRecognitionData_blind"))
```

## Body Size: Door Data
```{r}
#read csv data
bodySizeDoorData_buffer <- read.csv("./Data/bodySizeDoorData.csv")

#clean data frame
bodySizeDoorData <- bodySizeDoorData_buffer %>%
  mutate(errorFree = ifelse(errors_binary == "Yes", 0, 1)) %>% #recode: 0 = error present, 1 = no errors
  select(ID, errorFree) %>%
  rename(id = ID,
         bodySizeDoor_errorFree = errorFree)

#remove temporary variables
rm(bodySizeDoorData_buffer)
```

## Body Size: Toys Data
```{r}
#read csv data
bodySizeToysData_buffer <- read.csv("./Data/bodySizeToysData.csv")

#prepare data frame
bodySizeToysData <- bodySizeToysData_buffer %>%
  mutate(errorFree = ifelse(errors == 0, 1, 0)) %>% #check if trial without error (1) or with (0)
  mutate(errorFree = ifelse(interest == 1, NA, errorFree)) %>% #exclude trials with interest too low
  select(id, toy, errorFree) %>%
  group_by(id) %>%
  summarise(m_errorFree = mean(errorFree, na.rm = T)) %>% #calculate proportion of trials without errors
  rename(bodySizeToys_errorFree = m_errorFree)

#remove temporary variables
rm(bodySizeToysData_buffer)
```

## Body as Obstacle data
```{r}
#read csv data
bodyAsObstacleData_buffer <- read.csv("./Data/bodyAsObstacleData.csv")

#prepare data frame
bodyAsObstacleData <- bodyAsObstacleData_buffer %>%
  mutate(errorFree = ifelse(errors_binary == "Yes", 0, 1)) %>% #recode: 0 = error present, 1 = no errors
  group_by(ID) %>%
  summarise(m_errorFree = mean(errorFree))%>% #calculate proportion of trials without errors
  rename(id = ID,
         bodyObstacle_errorFree = m_errorFree)

#remove temporary variables
rm(bodyAsObstacleData_buffer)
```

## Self-Understanding Questionnaire data
```{r}
#read csv data
selfUnderstandingData_buffer <- read.csv("./Data/selfUnderstandingData.csv")

#prepare data frame
selfUnderstandingData <- selfUnderstandingData_buffer %>%
  mutate(passed = (self_description_rel + self_recognition_rel)/2) %>% #sum proportion of passed items per scale and create average passed items
  select(ID, passed) %>% 
  rename(id = ID,
         selfUnderstanding_passed = passed)

#remove temporary variables
rm(selfUnderstandingData_buffer)
```

## Placing Sticker on Self Data
```{r}
#read csv data
placingStickerData_buffer <- read.csv("./Data/placingStickerData.csv")

#prepare data frame
placingStickerData <- placingStickerData_buffer %>%
  mutate(correctPlace = ifelse(Placement == "of", 1, ifelse(Placement == -99, NA, 0))) %>% #check if correct placement (of = own face) or missing data
  select(ID, Type, correctPlace) %>%
  na.omit() %>% #omit missing data
  group_by(ID) %>%
  summarise(m_correctTrials = mean(correctPlace)) %>% #create proportion of trials with correct placement
  rename(id = ID,
         placing_correct = m_correctTrials)

#remove temporary variables
rm(placingStickerData_buffer)
```

##Language Data
```{r}
#read csv data
languageData_buffer <- read.csv("./Data/languageData.csv")

#prepare data frame
languageData <- languageData_buffer %>%
  select(VP.Code, Summe.Wortschatz) %>%
  rename(id = VP.Code,
         frakis_vocabulary = Summe.Wortschatz)

#remove temporary variables
rm(languageData_buffer)
```

## Join all data
```{r}
selfData <- merge(languageData, 
                  merge(demographicData,
                        merge(bodyAsObstacleData,
                              merge(bodySizeDoorData,
                                    merge(bodySizeToysData,
                                          merge(mirrorSelfRecognitionData,
                                                merge(placingStickerData,
                                                      merge(reachingToSelfData,
                                                            merge(selfUnderstandingData,
                                                                  merge(sensoryAttenuationData,
                                                                        merge(spatialContingencyData,
                                                                              merge(temporalContingencyData,
                                                                                    videoSelfRecognitionData,
                                                                                    by = "id",
                                                                                    all = TRUE),
                                                                              by = "id",
                                                                              all = TRUE),
                                                                        by = "id",
                                                                        all = TRUE),
                                                                  by = "id",
                                                                  all = TRUE),
                                                            by = "id",
                                                            all = TRUE),
                                                      by = "id",
                                                      all = TRUE),
                                                by = "id",
                                                all = TRUE),
                                          by = "id",
                                          all = TRUE),
                                    by = "id",
                                    all = TRUE),
                              by = "id",
                              all = TRUE),
                        by = "id",
                        all = TRUE),
                  by = "id",
                  all = TRUE)

save(selfData, file = "joinedSelfData.RData")
```


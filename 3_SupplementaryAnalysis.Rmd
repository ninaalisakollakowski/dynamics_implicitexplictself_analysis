---
title: "2_AnalyzeData"
author: "Nina-Alisa Kollakowski"
date: "`r Sys.Date()`"
output: html_document
---

## Initializing
```{r}
set.seed(350)
library(dplyr)
library(mice)
library(psych)
library(lavaan)

nImputations <- 500
nObservations <- 119
```

## Defining measures

```{r}
##defining measures
implicitSelfMeasures <- c("spatialContingency_looking", 
                          "spatialContingency_legs", 
                          "temporalContingency_looking",
                          "temporalContingency_left",
                          "temporalContingency_right",
                          "reaching_arm",
                          "reaching_head",
                          "sensoryAttenuation_pos",
                          "sensoryAttenuation_neg")
explicitSelfMeasures <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errorFree",
                          "bodySizeToys_errorFree", 
                          "bodyObstacle_errorFree", 
                          "selfUnderstanding_passed", 
                          "placing_correct")
continuousVariables <- c("spatialContingency_looking", 
                         "spatialContingency_legs", 
                         "temporalContingency_looking",
                         "temporalContingency_left",
                         "temporalContingency_right",
                         "reaching_arm",
                         "reaching_head",
                         "sensoryAttenuation_pos",
                         "sensoryAttenuation_neg",
                         "bodySizeToys_errorFree", 
                         "bodyObstacle_errorFree", 
                         "selfUnderstanding_passed", 
                         "placing_correct")
dichotomousVariables <- c("mirrorSelfRecognition", 
                          "videoSelfRecognition", 
                          "bodySizeDoor_errorFree")
demographicVariables_numeric <- c("education_mother",
                                  "education_father",
                                  "Age_Mother",
                                  "Age_Father",
                                  "age_T1_spatialContingency",
                                  "age_T1_temporalContingency",
                                  "age_T2_reaching",
                                  "age_sensoryAttenuation",
                                  "age_T3")
demographicVariables_factor <- c("Marital_Status_num",
                                 "Siblings_num",
                                 "Primary_Language_Child_num",
                                 "Primary_Caretaker_num",
                                 "sex")
```

## load imputed dataset
```{r}
load("imputedData.Rdata")
```

## compute correlation matrix for implicit/explicit measures for each imputed dataset
use psych::mixedCor for this
```{r echo=FALSE}
#initialize lists of correlations and standard deviations
correlationData_implicit <- vector("list", nImputations)
correlationData_explicit <- vector("list", nImputations)
standardDeviations_implicit <- vector("list", nImputations)
standardDeviations_explicit <- vector("list", nImputations)

for (i in 1:nImputations){
  #extract current imputed dataset
  curDataset <- complete(imputedData, action = i)
  
  #define factor variables back to numeric as otherwise correlation function does not work
  curDataset[dichotomousVariables] <- lapply(curDataset[dichotomousVariables], as.numeric)
  
  #compute standard deviations of measures as a matrix as needed for covariance matrix
  standardDeviations_implicit[[i]] <- diag(sapply(curDataset %>%
                                                    select(all_of(implicitSelfMeasures)),
                                                  sd)) #implicit
  
  standardDeviations_explicit[[i]] <- diag(sapply(curDataset %>%
                                                    select(all_of(explicitSelfMeasures)), 
                                                  sd)) #explicit
  
  #calculate correlations of implicit measures    
  correlationData_implicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(implicitSelfMeasures)),
                                            c = intersect(implicitSelfMeasures, continuousVariables),
                                            d = intersect(implicitSelfMeasures, dichotomousVariables))$rho 
  
  #calculate correlations of explicit measures
  correlationData_explicit[[i]] <- mixedCor(curDataset %>%
                                              select(all_of(explicitSelfMeasures)),
                                            c = intersect(explicitSelfMeasures, continuousVariables),
                                            d = intersect(explicitSelfMeasures, dichotomousVariables))$rho 
}
rm(curDataset)
```

## create covariance matrix from each correlation matrix
```{r}
#initialize lists of covariances
covarianceData_implicit <- vector("list", nImputations)
covarianceData_explicit <- vector("list", nImputations)

for (i in 1:nImputations){
  covarianceData_implicit[[i]] <- standardDeviations_implicit[[i]] %*% correlationData_implicit[[i]] %*% standardDeviations_implicit[[i]]
  
  covarianceData_explicit[[i]] <- standardDeviations_explicit[[i]] %*% correlationData_explicit[[i]] %*% standardDeviations_explicit[[i]]
}
```

## create average matrices for implicit/explicit measures
```{r}
covariance_implicit <- apply(simplify2array(covarianceData_implicit), c(1,2), mean)
rownames(covariance_implicit) <- implicitSelfMeasures
colnames(covariance_implicit) <- implicitSelfMeasures

covariance_explicit <- apply(simplify2array(covarianceData_explicit), c(1,2), mean)
rownames(covariance_explicit) <- explicitSelfMeasures
colnames(covariance_explicit) <- explicitSelfMeasures

correlation_implicit <- apply(simplify2array(correlationData_implicit), c(1,2), mean)
rownames(correlation_implicit) <- implicitSelfMeasures
colnames(correlation_implicit) <- implicitSelfMeasures

correlation_explicit <- apply(simplify2array(correlationData_explicit), c(1,2), mean)
rownames(correlation_explicit) <- explicitSelfMeasures
colnames(correlation_explicit) <- explicitSelfMeasures

```

##perform EFA for implicit measures
1) Bartlett's test to check if correlation matrix different from identity matrix (needs to be significant)
```{r Bartlett implicit}
cortest.bartlett(correlation_implicit, n = nObservations) #significant -> proceed
```

2) KMO >=.5, otherwise exclude variables with smallest KMO until criterion is reached
as EFA produces Heywood cases, trying to exclude all variables with KMO <.5 iteratively
```{r KMO implicit}
KMO(correlation_implicit) #KMO = 0.42, exclude sensoryAttenuation_neg  (0.32)
correlation_implicit1 <- correlation_implicit[!rownames(correlation_implicit) == "sensoryAttenuation_neg",
                                              !colnames(correlation_implicit) == "sensoryAttenuation_neg"]
excludedVariables_implicit_KMO <- list("sensoryAttenuation_neg")
excludedVariables_implicit <- list("sensoryAttenuation_neg")

#run KMO again
KMO(correlation_implicit1) #KMO = 0.47 -> exclude reaching_head (0.40)
correlation_implicit2 <- correlation_implicit1[!rownames(correlation_implicit1) == "reaching_head",
                                              !colnames(correlation_implicit1) == "reaching_head"]
excludedVariables_implicit_KMO <- append(excludedVariables_implicit_KMO, "reaching_head")
excludedVariables_implicit <- append(excludedVariables_implicit, "reaching_head")

KMO(correlation_implicit2) #KMO = 0.5, exclude reaching_arm (0.46)
correlation_implicit3 <- correlation_implicit2[!rownames(correlation_implicit2) == "reaching_arm",
                                              !colnames(correlation_implicit2) == "reaching_arm"]
excludedVariables_implicit_KMO <- append(excludedVariables_implicit_KMO, "reaching_arm")
excludedVariables_implicit <- append(excludedVariables_implicit, "reaching_arm")

KMO(correlation_implicit3) #KMO = 0.51, exclude temporalContingency_left (0.44)
correlation_implicit4 <- correlation_implicit3[!rownames(correlation_implicit3) == "temporalContingency_left",
                                              !colnames(correlation_implicit3) == "temporalContingency_left"]
excludedVariables_implicit_KMO <- append(excludedVariables_implicit_KMO, "temporalContingency_left")
excludedVariables_implicit <- append(excludedVariables_implicit, "temporalContingency_left")

KMO(correlation_implicit4) #KMO = 0.58, all variables >.5

cur_correlation_implicit <- correlation_implicit4
```

3) parallel analysis with reduced correlation matrix to decide number of factors

```{r parallel analysis implicit}
fa.parallel(cur_correlation_implicit, n.obs = nObservations, n.iter = 1000, fm = "ml", fa = "fa")
```
parallel analysis suggests 2 factors      

4) run EFA with principal axis factoring with oblique (direct oblimin) rotation
```{r EFA implicit}
#run EFA with 3 factors as suggested by parallel analysis
efa.implicit <- fa(cur_correlation_implicit, nfactors = 2, n.obs = nObservations, 
                   rotate = 'oblimin', fm = 'pa', max.iter = 1000)

#print results: cut-off of .4 as only loadings with >=.4 will be assigned to this factor
print.psych(efa.implicit, cut = .39, digits=3, sort=TRUE)

```

5) average imputed datasets for implicit variable scores
```{r implicit scores}
variables_implicit <- vector("list", nImputations)

#average imputed datasets for variable scores
for (i in 1:nImputations){
  curDataset <- complete(imputedData, action = i)
  
  variables_implicit[[i]] <- data.matrix(curDataset %>%
                                           select(all_of(implicitSelfMeasures)))
}

implicitSelf <- data.frame(apply(simplify2array(variables_implicit), c(1,2), mean))
implicitSelf <- mutate(implicitSelf, id = 1:nObservations)
```


## perform EFA for explicit measures
1) Bartlett's test to check if correlation matrix different from identity matrix (needs to be significant)
```{r Bartlett explicit}
cortest.bartlett(correlation_explicit, n = nObservations) #significant -> proceed
```

2) KMO >.5, otherwise exclude variables with smallest KMO until criterion is reached
as EFA produces Heywood cases, trying to exclude all variables with KMO <.5 iteratively
```{r KMO explicit}
KMO(correlation_explicit) #KMO = 0.52, excluding bodyObstacle_errorFree (0.29)
correlation_explicit1 <- correlation_explicit[!rownames(correlation_explicit) == "bodyObstacle_errorFree",
                                              !colnames(correlation_explicit) == "bodyObstacle_errorFree"]
excludedVariables_explicit_KMO <- list("bodyObstacle_errorFree")
excludedVariables_explicit <- list("bodyObstacle_errorFree")

KMO(correlation_explicit1) #KMO = 0.54, but variables <.5 -> excluding bodySizeToys_errorFree (0.36)
correlation_explicit2 <- correlation_explicit1[!rownames(correlation_explicit1) == "bodySizeToys_errorFree",
                                              !colnames(correlation_explicit1) == "bodySizeToys_errorFree"]
excludedVariables_explicit_KMO <- append(excludedVariables_explicit_KMO, "bodySizeToys_errorFree")
excludedVariables_explicit <- append(excludedVariables_explicit, "bodySizeToys_errorFree")

KMO(correlation_explicit2) #KMO = 0.65, all variables >0.5 -> proceed

cur_correlation_explicit <- correlation_explicit2
```

3) parallel analysis with reduced correlation matrix to decide number of factors

```{r parallel analysis explicit}
fa.parallel(cur_correlation_explicit, n.obs = nObservations, n.iter = 1000, fm = "ml", fa = "fa")
```
parallel analysis suggests 2 factors

4) run EFA with principal axis factoring with oblique (direct oblimin) rotation
```{r EFA explicit}
#run EFA with 3 factors as suggested by parallel analysis
efa.explicit <- fa(cur_correlation_explicit, nfactors = 2, n.obs = nObservations, 
                   rotate = 'oblimin', fm = 'pa', max.iter = 1000)

#print results: cut-off of .4 as only loadings with >=.4 will be assigned to this factor
print.psych(efa.explicit, cut = .39, digits=3, sort=TRUE) 

```

5) assign variables to factors with loadings of >=.4
```{r assign to explicit factors}
#exclude variables that don't load on any factor with loading of >=.4
excludedVariables_explicit <- append(excludedVariables_explicit, "selfUnderstanding_passed")

#extract factor loading from EFA
relevantFactorLoadings_explicit <- efa.explicit$loadings

#replace loadings < 0.4 with 0 for correct calculation of factor scores
relevantFactorLoadings_explicit[abs(relevantFactorLoadings_explicit) < 0.4] <- 0
```

6) calculate factor scores
```{r explicit factor scores}
#initialize lists for factor scores and all excluded variables
factorScores_explicit <- vector("list", nImputations)
otherVariables_explicit <- vector("list", nImputations)

#calculate factor scores and scores for excluded variables for each imputed dataset
for (i in 1:nImputations){
  curDataset <- complete(imputedData, action = i)
  
  #define factor variables back to numeric to be able to compute means
  curDataset[dichotomousVariables] <- lapply(curDataset[dichotomousVariables], as.numeric)
  
  factorScore_buffer <- curDataset %>%
    select(all_of(setdiff(explicitSelfMeasures, excludedVariables_explicit_KMO))) %>%
    factor.scores(x = ., relevantFactorLoadings_explicit)
  
  factorScores_explicit[[i]] <- factorScore_buffer$scores
  
  otherVariables_explicit[[i]] <- data.matrix(curDataset %>%
                                                select(all_of(simplify2array(excludedVariables_explicit))))
}
rm(factorScore_buffer)
rm(curDataset)

#create average factor scores and excluded variable scores for all datasets
factorScores_explicit_avg <- apply(simplify2array(factorScores_explicit), c(1,2), mean)
otherVariables_explicit_avg <- apply(simplify2array(otherVariables_explicit), c(1,2), mean)

#combine factor scores and scores for excluded variables into dataframe for explicit self
explicitSelf <- cbind(as.data.frame(factorScores_explicit_avg), as.data.frame(otherVariables_explicit_avg))
explicitSelf <- explicitSelf %>%
  rename(explicitFactor1 = PA1,
         explicitFactor2 = PA2) %>%
  mutate(id = 1:nObservations)
```


## linear regressions of implicit -> explicit self
run regressions of each explicit factor/variable with all implicit variables as predictors
```{r prepare dataframe}
#merge implicit and explicit dataset
selfData <- merge(implicitSelf, explicitSelf, by = "id")
```

```{r explicit factor 1}
explicitFactor1.model <- lm(explicitFactor1 ~ spatialContingency_looking + 
                              spatialContingency_legs +
                              temporalContingency_looking +
                              temporalContingency_left +
                              temporalContingency_right +
                              reaching_arm +
                              reaching_head +
                              sensoryAttenuation_pos +
                              sensoryAttenuation_neg, 
                            data = selfData)
summary(explicitFactor1.model)
confint(explicitFactor1.model)
```

```{r explicit factor 2}
explicitFactor2.model <- lm(explicitFactor2 ~ spatialContingency_looking + 
                              spatialContingency_legs +
                              temporalContingency_looking +
                              temporalContingency_left +
                              temporalContingency_right +
                              reaching_arm +
                              reaching_head +
                              sensoryAttenuation_pos +
                              sensoryAttenuation_neg, 
                            data = selfData)
summary(explicitFactor2.model)
confint(explicitFactor2.model)
```

```{r body obstacle}
bodyObstacle.model <- lm(bodyObstacle_errorFree ~ spatialContingency_looking + 
                           spatialContingency_legs +
                           temporalContingency_looking +
                           temporalContingency_left +
                           temporalContingency_right +
                           reaching_arm +
                           reaching_head +
                           sensoryAttenuation_pos +
                           sensoryAttenuation_neg, 
                         data = selfData)
summary(bodyObstacle.model)
confint(bodyObstacle.model)
```

```{r body size toys}
bodySizeToys.model <- lm(bodySizeToys_errorFree ~ spatialContingency_looking + 
                           spatialContingency_legs +
                           temporalContingency_looking +
                           temporalContingency_left +
                           temporalContingency_right +
                           reaching_arm +
                           reaching_head +
                           sensoryAttenuation_pos +
                           sensoryAttenuation_neg, 
                         data = selfData)
summary(bodySizeToys.model)
confint(bodySizeToys.model)
```